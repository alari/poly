<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="auth-signup.html">
<link rel="import" href="auth-signin.html">

<dom-module id="auth-buttons">

  <template>
    <auth-token id="token"></auth-token>
    <auth-user id="user" value="{{user}}"></auth-user>

    <meta-route href="/api/auth" expand="user" meta-response="{{authResponse}}">

      <is-auth>
        <span>{{user.name}}</span>
        <paper-icon-button icon="icons:settings-power" on-click="signOut"></paper-icon-button>
      </is-auth>

      <not-auth>
        <paper-icon-button icon="icons:perm-identity" on-click="toggleAuth"></paper-icon-button>
        <paper-icon-button icon="icons:power-settings-new" on-click="toggleSignup"></paper-icon-button>
      </not-auth>

      <auth-signin id="signin"></auth-signin>
      <auth-signup id="signup"></auth-signup>
    </meta-route>


  </template>
  <script>
    (function () {
      "use strict";
      Polymer({
        is: "auth-buttons",
        properties: {
          authResponse: {
            type: Object,
            observer: "authResp",
            notify: true
          },
          user: {
            type: Object,
            notify: true
          }
        },
        authResp: function () {
          console.log("got auth resp", this.authResponse);

          if (!!this.authResponse) {
            this.authResponse.meta = {
              href: "/api/auth",
              mediaType: "application/auth-status+json;expand=user"
            };

            if(!this.authResponse.failure) {
              this.$.user.setUser(this.authResponse.user);
              this.$.user.setRoles(this.authResponse.roles);

              this.$.signin.close();
              this.$.signup.close();
            }

          } else {
            this.$.user.setUser(null);
            this.$.user.setRoles([]);
          }

        },
        toggleAuth: function () {
          this.$.signin.toggle();
          this.$.signup.close();
        },
        toggleSignup: function () {
          this.$.signup.toggle();
          this.$.signin.close();
        },
        signOut: function () {
          this.$.token.setValue(null);
          this.$.user.setUser(null);
          this.$.user.setRoles([]);
          this.authResponse = {};
        }
      });
    })();
  </script>
</dom-module>