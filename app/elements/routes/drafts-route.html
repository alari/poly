<link rel="import" href="../node/nodes-list.html">
<link rel="import" href="../node/kinds-tabs.html">

<dom-module id="drafts-route">
  <template>
    <page-info title="Черновики"></page-info>
    <auth-user value="{{user}}"></auth-user>

    <kinds-tabs values="{{kinds}}" kinds-agg="{{lastJson.agg.kind}}"></kinds-tabs>

    <div style="position: absolute;">
      <paper-spinner active$="{{!lastJson}}"></paper-spinner>
    </div>

    <meta-route no-load with-stream ref="{{draftsHref(kinds.splices,user)}}" id="route" expand="items.{text,user},agg.{count,kind.distinct.count}"
                model="{{lastJson}}">

      <nodes-list model="{{lastJson}}"></nodes-list>

    </meta-route>

  </template>
  <script>
    Polymer({
      is: "drafts-route",
      properties: {
        user: {
          type: Object,
          notify: true,
          observer: "userChanged"
        },
        kinds: {
          type: Array,
          value: ["Post", "Article", "Prose", "Poetry"]
        }
      },
      userChanged: function () {
        this.$.route.href = this.draftsHref();
      },
      attached: function () {
        this.userChanged();
      },
      draftsHref: function () {
        if (!!this.user && this.user.id) {
          if (this.$.route.noLoad) {
            var r = this.$.route;
            this.async(function () {
              r.noLoad = false;
            });
          }
          return "/api/nodes?draft=true&userId=" + this.user.id + "&kinds=" + R.join(',', R.sortBy(R.toLower, this.kinds));
        } else {
          this.$.route.noLoad = true;
        }
      }
    });
  </script>
</dom-module>