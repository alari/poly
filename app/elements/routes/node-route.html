<dom-module id="node-route">
  <style>
    paper-material {
      background-color: white;
      min-height: 120px;
      max-width: 720px;
      margin: 0px auto;
    }

    :host .container {
      padding: 2em;
    }
  </style>
  <template>
    <meta-route load href="{{computeNodeHref(routeParams)}}" expand="user,text" meta-response="{{node}}">

      <page-info title="{{node.title}}"></page-info>

      <paper-material elevation="1">
        <div class="container">

          <h1>{{node.title}}</h1>

          <meta-resource model="{{node.text}}">
            <render-remarkable input="{{node.text.content}}"></render-remarkable>
          </meta-resource>

          <div id="settings">
            <user-link user="{{node.user}}"></user-link>
            <is-auth user="{{node.user}}">

              <paper-icon-button icon="editor:mode-edit" on-tap="gotoEdit"></paper-icon-button>
              <meta-button body$="{{computeDraftMetaBody(node.draft)}}" on-complete="_toggleDraft" no-content>
                <paper-icon-button icon$="{{computeDraftIcon(node.draft)}}"></paper-icon-button>
              </meta-button>

            </is-auth>
          </div>
        </div>
      </paper-material>

    </meta-route>
  </template>
  <script>
    Polymer({
      is: "node-route",

      properties: {
        routeParams: {
          type: Object,
          notify: true
        },
        node: {
          type: Object,
          notify: true
        }
      },

      computeNodeHref: function (routeParams) {
        return "/api/nodes/" + routeParams.name;
      },

      computeDraftIcon: function (node) {
        console.log("compute draft icon");
        if (!node || node.draft) {
          return "visibility-off";
        } else {
          return "visibility";
        }
      },

      computeDraftMetaBody: function () {
        return {draft: this.node ? !this.node.draft : true};
      },

      gotoEdit: function () {
        page("/nodes/" + this.node.id + "/edit");
      },

      _toggleDraft: function () {
        this.node.draft = !this.node.draft;
        this.notifyPath("node.draft", this.node.draft);
      }
    });
  </script>
</dom-module>