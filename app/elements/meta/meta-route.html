<link rel="import" href="../auth/auth-fetch.html">

<dom-module id="meta-route">
  <template>
    <auth-fetch auto="{{!noLoad}}" url="{{href}}" last-json="{{metaResponse}}" params="{{params}}"></auth-fetch>
    <meta-resource model="{{metaResponse}}">
      <content></content>
    </meta-resource>
  </template>
  <script>
    Polymer({
      is: "meta-route",
      properties: {
        href: {
          type: String,
          reflectToAttribute: true
        },
        metaResponse: {
          type: Object,
          notify: true,
          observer: "_metaResponseChanged"
        },
        expand: {
          type: String,
          notify: true,
          value: ""
        },
        noLoad: {
          type: Boolean,
          notify: true,
          value: false
        },
        params: {
          computed: "_computeParams(expand)"
        }
      },
      _computeParams: function (expand) {
        if (!!expand) {
          return {
            headers: {
              Accept: "application/json;expand=" + expand
            }
          };
        } else {
          return {};
        }
      },
      _metaResponseChanged: function () {
        if(!!window.EventSource) {
          if (!!this.stream) {
            this.stream.close();
          }
          if (this.metaResponse && this.metaResponse.meta && this.metaResponse.meta.stream) {
            this.stream = new window.EventSource(this.metaResponse.meta.stream);
            var self = this;
            this.stream.onmessage = function (e) {
              var data = JSON.parse(e.data);
              self.fire("iron-signal", {name: data.meta.href, data: data});
            };
          }
        }
      },
      detached: function() {
        if(!!this.stream) {
          this.stream.close();
        }
      }
    });
  </script>
</dom-module>