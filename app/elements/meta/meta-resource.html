<dom-module id="meta-resource">
  <template>
    <auth-fetch id="fetch" on-json="_respJson" on-text="_respText" on-error="_respError"></auth-fetch>
    <content></content>
  </template>
  <script>
    Polymer({
      is: "meta-resource",
      properties: {
        model: {
          type: Object,
          notify: true
        }
      },
      listeners: {
        'metaAction': '_action'
      },
      _action: function(e) {
        if(this.model.meta && (!e.detail.href || (e.detail.href == this.model.meta.href))) {
          e.stopPropagation();
          console.log(e.detail);
          this.$.fetch.params = {
            method: e.detail.method,
            headers: {
              Accept: this.model.meta.mediaType,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(e.detail.body || this.model)
          };
          this.$.fetch.url = this.model.meta.href + (Boolean(e.detail.action) ? "/actions/"+ e.detail.action : "");
          this.button = e.target;
          this.updateModel = e.detail.updateModel;
          this.updateErrorModel = e.detail.updateErrorModel;
          this.$.fetch.generateRequest();
        }
      },
      _handleResp: function(event, v, updateModel) {
        if(!!this.button) {
          this.button.fire("complete", v);
          this.button = null;
        }
        if(updateModel) {
          this.model = v;
        }
        this.updateErrorModel = false;
        this.updateModel = false;
      },
      _respJson: function(e) {
        console.log("yes, resp json", e);
        this._handleResp("complete", e.detail, this.updateModel);
      },
      _respText: function(e) {
        this._handleResp("complete", e.detail, this.updateModel);
      },
      _respErrorText: function(e) {
        this._handleResp("error", e.detail, this.updateErrorModel);
      }
    })
  </script>
</dom-module>